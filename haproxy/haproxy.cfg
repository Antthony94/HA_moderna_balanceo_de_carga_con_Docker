global
    log stdout format raw local0
    maxconn 2000

defaults
    log global
    mode http
    option httplog
    timeout connect 5s
    timeout client 30s
    timeout server 30s

frontend fe_http
    bind *:80
    # Si la URL empieza por /14/, usa el backend con check superficial (TCP)
    acl is_14 path_beg /14/
    use_backend be_14 if is_14
    # Por defecto usa el backend con check funcional (HTTP 200)
    default_backend be_17

backend be_17
    balance roundrobin
    # Check L7: Debe devolver HTTP 200 en /health
    option httpchk GET /health
    http-check expect status 200
    default-server inter 2s fall 3 rise 2
    server app1 app1:80 check
    server app2 app2:80 check
    server app3 app3:80 check

backend be_14
    balance roundrobin
    # Check L4: Solo comprueba conexión TCP (superficial)
    option tcp-check
    default-server inter 2s fall 3 rise 2
    # Elimina el prefijo /14 antes de enviar la petición al backend
    http-request set-path %[path,regsub(^/14,)]
    server app1 app1:80 check
    server app2 app2:80 check
    server app3 app3:80 check

listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 5s
